<div class="view items-view">
  <header class="view-header">
    <div>
      <h1 class="view-title">Items</h1>
      <p class="view-subtitle">
        Maintain your product catalogue, pricing tiers, and roll-based stock in one place.
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-ghost" type="button" (click)="openBarcodeModal()">
        Barcode Backfill
      </button>
      <button class="btn btn-primary" type="button" (click)="openAdd()">
        Add Item
      </button>
    </div>
  </header>

  <section class="surface-card controls-card">
    <div class="controls">
      <label class="form-field slim">
        <span>Filter by category</span>
        <select
          [(ngModel)]="selectedCategory"
          (change)="filterItems()"
        >
          <option [ngValue]="null" disabled>Choose category</option>
          <option *ngFor="let cat of categories" [ngValue]="cat">{{ cat }}</option>
          <option value="all">All categories</option>
        </select>
      </label>

      <span class="pill" *ngIf="filteredItems.length">
        {{ filteredItems.length }} item{{ filteredItems.length === 1 ? '' : 's' }}
      </span>
    </div>
  </section>

  <div *ngIf="showForm" class="item-form-overlay">
    <form (ngSubmit)="saveItem()" class="item-form">
      <header class="item-form__header">
        <h3>{{ itemForm.id ? 'Edit Item' : 'Add Item' }}</h3>
        <button type="button" class="icon-btn" (click)="cancelForm()" aria-label="Close form">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3z"
            />
          </svg>
        </button>
      </header>

      <div class="form-grid">
        <label class="form-field">
          <span>Name</span>
          <input [(ngModel)]="itemForm.name" name="name" placeholder="Name" required autofocus />
        </label>

        <label class="form-field">
          <span>Model / SKU</span>
          <input [(ngModel)]="itemForm.sku" name="sku" placeholder="Model number" />
        </label>

        <label class="form-field">
          <span>Category</span>
          <select [(ngModel)]="itemForm.category" name="category">
            <option [ngValue]="undefined">Select category</option>
            <option value="internet">Internet</option>
            <option value="solar">Solar</option>
            <option value="camera">Camera</option>
            <option value="satellite">Satellite</option>
          </select>
        </label>

        <label class="form-field">
          <span>Stock unit</span>
          <select [(ngModel)]="itemForm.stockUnit" name="stockUnit">
            <option [ngValue]="undefined">Each (pieces)</option>
            <option value="m">Meters (rolls)</option>
            <option value="cm">Centimeters (converted to m)</option>
          </select>
        </label>

        <label class="form-field" *ngIf="itemForm.stockUnit !== 'm'">
          <span>Stock (pieces)</span>
          <input
            [(ngModel)]="itemForm.stock"
            name="stock"
            type="number"
            min="0"
            step="1"
            placeholder="Pieces in stock"
            required
          />
        </label>
      </div>

      <div
        class="serials-section"
        *ngIf="!itemForm.id && itemForm.stockUnit !== 'm'"
      >
        <label class="checkbox-inline">
          <input
            type="checkbox"
            [(ngModel)]="autoSerialInitial"
            (change)="onAutoSerialInitialToggle()"
          />
          Auto-generate serial numbers
        </label>
        <label class="form-field" *ngIf="!autoSerialInitial">
          <span>Initial serial numbers</span>
          <textarea
            rows="4"
            [(ngModel)]="serialInput"
            name="serialInput"
            placeholder="Scan or type barcodes, one per line"
          ></textarea>
          <small class="hint">
            Provide one serial per piece; stock will match the number entered.
          </small>
        </label>
        <small class="hint" *ngIf="autoSerialInitial">
          Serial numbers will be generated automatically for {{ itemForm.stock || 0 }} pieces.
        </small>
      </div>

      <div class="meter-section" *ngIf="itemForm.stockUnit === 'm'">
        <ng-container *ngIf="!itemForm.id; else rollEdit">
          <div class="form-grid">
            <label class="form-field">
              <span>Number of rolls (create now)</span>
              <input
                [(ngModel)]="rollCreateCount"
                name="rollCreateCount"
                type="number"
                min="0"
                step="1"
                placeholder="e.g. 3"
              />
            </label>
            <label class="form-field">
              <span>Each roll length (m)</span>
              <input
                [(ngModel)]="rollCreateLength"
                name="rollCreateLength"
                type="number"
                min="0.001"
                step="0.001"
                placeholder="e.g. 100"
              />
            </label>
          </div>
          <p class="form-hint" *ngIf="rollCreateCount && rollCreateLength">
            Will create {{ rollCreateCount }} × {{ rollCreateLength }} m =
            <b>{{ rollCreateCount * rollCreateLength | number : '1.3-3' }}</b> meters in stock.
          </p>
        </ng-container>

        <ng-template #rollEdit>
          <hr />
          <h4>Add additional rolls</h4>
          <div class="form-grid">
            <label class="form-field">
              <span>Number of rolls</span>
              <input
                [(ngModel)]="rollAddCount"
                name="rollAddCount"
                type="number"
                min="1"
                step="1"
                placeholder="e.g. 2"
              />
            </label>
            <label class="form-field">
              <span>Each roll length (m)</span>
              <input
                [(ngModel)]="rollAddLength"
                name="rollAddLength"
                type="number"
                min="0.001"
                step="0.001"
                placeholder="e.g. 80"
              />
            </label>
          </div>
        </ng-template>
      </div>

      <div class="form-grid">
        <label class="form-field">
          <span>Retail price</span>
          <input
            [(ngModel)]="itemForm.priceRetail"
            name="priceRetail"
            type="number"
            step="0.01"
            min="0"
            placeholder="Retail price"
          />
        </label>

        <label class="form-field">
          <span>Wholesale price</span>
          <input
            [(ngModel)]="itemForm.priceWholesale"
            name="priceWholesale"
            type="number"
            step="0.01"
            min="0"
            placeholder="Wholesale price"
          />
        </label>
      </div>

      <label class="form-field">
        <span>Description</span>
        <input
          [(ngModel)]="itemForm.description"
          name="description"
          placeholder="Optional description"
        />
      </label>

      <div class="form-actions">
        <button class="btn btn-primary" type="submit">
          {{ itemForm.id ? 'Update Item' : 'Create Item' }}
        </button>
        <button class="btn" type="button" (click)="cancelForm()">Cancel</button>
      </div>
    </form>
  </div>

  <section class="table-card">
    <table *ngIf="pagedItems.length; else noData">
      <thead>
        <tr>
          <th>Name</th>
          <th>SKU</th>
          <th>Category</th>
          <th>Stock</th>
          <th>Prices</th>
          <th>Description</th>
          <th class="th-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let item of pagedItems">
        <tr>
          <td>{{ item.name }}</td>
          <td>{{ item.sku }}</td>
          <td>{{ item.category }}</td>
          <td>
            {{ item.stock }}
            <span *ngIf="item.stockUnit">&nbsp;{{ item.stockUnit }}</span>
          </td>
          <td>
            <div>Retail: {{ item.priceRetail ?? item.price | number : '1.2-2' }}</div>
            <div *ngIf="item.priceWholesale != null">
              Wholesale: {{ item.priceWholesale | number : '1.2-2' }}
            </div>
            <small *ngIf="item.stockUnit === 'm'">per metre</small>
          </td>
          <td>{{ item.description }}</td>
          <td class="actions">
            <button
              class="icon-btn"
              title="Inventory units"
              aria-label="Inventory units"
              (click)="toggleUnits(item)"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"
                />
              </svg>
              <span class="sr-only">Inventory</span>
            </button>
            <button
              class="icon-btn"
              title="Edit"
              aria-label="Edit item"
              (click)="openEdit(item)"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M3 17.25V21h3.75L17.8 9.94l-3.75-3.75L3 17.25zm18.7-10.2a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15.12 5.13l3.75 3.75 2.83-2.83z"
                />
              </svg>
              <span class="sr-only">Edit</span>
            </button>

            <button
              class="icon-btn"
              [class.has-photo]="!!item.photoUrl"
              title="Manage photo"
              aria-label="Manage photo"
              (click)="openPhotoModal(item)"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M21 19V7a2 2 0 0 0-2-2h-2.6l-1.2-1.6A1.5 1.5 0 0 0 14 2H10a1.5 1.5 0 0 0-1.2.6L7.6 5H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-13-7.5a2 2 0 1 1 2 2 2 2 0 0 1-2-2zm2.5 3.5 2.5 3 2.5-3 3.5 4.5h-14z"
                />
              </svg>
              <span class="photo-dot" *ngIf="item.photoUrl"></span>
              <span class="sr-only">Photo</span>
            </button>

            <button
              class="icon-btn danger"
              title="Delete"
              aria-label="Delete item"
              (click)="deleteItem(item.id)"
            >
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 7h12v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V7zm3-4h6l1 1h4v2H4V4h4l1-1z"
                />
              </svg>
              <span class="sr-only">Delete</span>
            </button>
          </td>
        </tr>
        <tr class="units-row" *ngIf="expandedItemId === item.id">
          <td colspan="7">
            <div class="units-panel">
              <header class="units-panel__head">
                <div>
                  <h4>Tracked units</h4>
                  <p class="subtle">
                    {{ unitsByItem[item.id]?.length || 0 }} total units
                  </p>
                </div>
                <div class="unit-head-actions">
                  <button class="btn btn-ghost btn-sm" type="button" (click)="openBarcodeModal(item)">
                    Assign barcodes
                  </button>
                  <button class="btn btn-ghost btn-sm" type="button" (click)="fetchUnits(item.id)">
                    Refresh
                  </button>
                </div>
              </header>

              <ng-container *ngIf="!unitsLoading; else unitsLoadingTpl">
                <p class="error" *ngIf="unitsError">{{ unitsError }}</p>
                <table class="units-table" *ngIf="unitsByItem[item.id]?.length; else noUnitsTpl">
                  <thead>
                    <tr>
                      <th>Barcode</th>
                      <th>Status</th>
                      <th>Placeholder</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let unit of unitsByItem[item.id]">
                      <td>
                        <span class="mono" [class.placeholder]="unit.isPlaceholder">
                          {{ unit.barcode || '—' }}
                        </span>
                      </td>
                      <td>
                        <span class="status-pill" [class]="unit.status">{{ unit.status }}</span>
                      </td>
                      <td>{{ unit.isPlaceholder ? 'Yes' : 'No' }}</td>
                      <td class="unit-actions">
                        <button class="btn btn-ghost btn-sm" type="button" (click)="assignBarcode(unit)">
                          {{ unit.barcode ? 'Edit barcode' : 'Assign barcode' }}
                        </button>
                        <button
                          class="btn btn-ghost btn-sm"
                          type="button"
                          (click)="showUnitHistory(unit)"
                        >
                          History
                        </button>
                        <button
                          class="btn btn-ghost btn-sm"
                          type="button"
                          *ngIf="unit.status === 'sold'"
                          (click)="markUnit(unit, 'restock')"
                        >
                          Restock
                        </button>
                        <button
                          class="btn btn-ghost btn-sm danger"
                          type="button"
                          *ngIf="unit.status === 'sold'"
                          (click)="markUnit(unit, 'defective')"
                        >
                          Defective
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </ng-container>
            </div>
          </td>
        </tr>
        </ng-container>
      </tbody>
    </table>

    <ng-template #unitsLoadingTpl>
      <p class="subtle">Loading units…</p>
    </ng-template>
    <ng-template #noUnitsTpl>
      <p class="subtle">No tracked units yet.</p>
    </ng-template>

    <ng-template #noData>
      <p class="empty-state">No items found.</p>
    </ng-template>
  </section>

  <div class="pagination" *ngIf="totalPages > 1">
    <button class="btn" type="button" (click)="prevPage()" [disabled]="currentPage === 1">
      Previous
    </button>
    <span>Page {{ currentPage }} of {{ totalPages }}</span>
    <button class="btn" type="button" (click)="nextPage()" [disabled]="currentPage === totalPages">
      Next
    </button>
  </div>
</div>

<div
  class="modal-backdrop"
  *ngIf="photoModalOpen"
  (click)="closePhotoModal()"
></div>
<div class="modal" *ngIf="photoModalOpen" (click)="$event.stopPropagation()">
  <h3>Item Photo</h3>

  <div class="photo-preview">
    <img
      *ngIf="photoPreviewUrl || photoItem?.photoUrl"
      [src]="photoPreviewUrl || fileUrl(photoItem?.photoUrl || null) || ''"
      alt="Item photo"
    />
    <div class="placeholder" *ngIf="!photoPreviewUrl && !photoItem?.photoUrl">
      No photo
    </div>
  </div>

  <div class="modal-actions">
    <label class="icon-btn" title="Choose file" aria-label="Choose file">
      <input
        type="file"
        accept="image/*"
        hidden
        (change)="onPhotoFileChange($event)"
      />
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M10 4H4a2 2 0 0 0-2 2v3h20V8a2 2 0 0 0-2-2h-6l-2-2zM22 10H2v8a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-8z"
        />
      </svg>
      <span class="sr-only">Choose file</span>
    </label>

    <button
      class="icon-btn primary"
      [disabled]="!selectedFile || uploading"
      (click)="uploadPhoto()"
      title="Upload"
      aria-label="Upload"
    >
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M19 18a4 4 0 0 0-3.8-4A5.5 5.5 0 0 0 6 10.5a5.5 5.5 0 0 0 .3 1.8A4 4 0 1 0 5 20h13a3 3 0 0 0 1-5.8zM12 13l-4 4h3v4h2v-4h3l-4-4z"
        />
      </svg>
      <span class="sr-only">Upload</span>
    </button>

    <button
      class="icon-btn"
      [disabled]="uploading"
      (click)="closePhotoModal()"
      title="Close"
      aria-label="Close"
    >
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.7 2.88 18.3 9.17 12 2.88 5.71 4.29 4.3 10.6 10.6l6.29-6.3z"
        />
      </svg>
      <span class="sr-only">Close</span>
    </button>

    <span class="spacer"></span>

    <button
      class="icon-btn danger"
      [disabled]="uploading || !photoItem?.photoUrl"
      (click)="removePhoto()"
      title="Remove photo"
      aria-label="Remove photo"
    >
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M6 7h12v14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V7zm3-4h6l1 1h4v2H4V4h4l1-1z"
        />
      </svg>
      <span class="sr-only">Remove</span>
    </button>
  </div>
</div>

<div
  class="modal-backdrop"
  *ngIf="barcodeModalOpen"
  (click)="closeBarcodeModal()"
></div>
<div class="barcode-modal" *ngIf="barcodeModalOpen" (click)="$event.stopPropagation()">
  <header class="barcode-modal__head">
    <div>
      <h3>Barcode Backfill</h3>
      <p class="subtle">Scan or auto-generate serials for existing stock.</p>
    </div>
    <button class="icon-btn" type="button" (click)="closeBarcodeModal()" aria-label="Close">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.7 2.88 18.3 9.17 12 2.88 5.71 4.29 4.3 10.6 10.6l6.29-6.3z"
        />
      </svg>
    </button>
  </header>

  <label class="form-field">
    <span>Select item</span>
    <select [(ngModel)]="barcodeItemId" (ngModelChange)="onBarcodeItemChange()">
      <option [ngValue]="null" disabled>Select an item</option>
      <option *ngFor="let item of items" [ngValue]="item.id">
        {{ item.name }} ({{ item.sku || 'no sku' }})
      </option>
    </select>
  </label>

  <div *ngIf="barcodeLoading" class="state subtle">Loading pending units�?�</div>

  <ng-container *ngIf="!barcodeLoading">
    <div *ngIf="nextBarcodeUnit; else noPending">
      <div class="current-unit-card">
        <div>
          <h4>Next unit #{{ nextBarcodeUnit.id }}</h4>
          <p class="subtle">
            Placeholder: {{ nextBarcodeUnit.isPlaceholder ? 'Yes' : 'No' }} �?�
            Created:
            {{
              nextBarcodeUnit.createdAt
                ? (nextBarcodeUnit.createdAt | date : 'short')
                : 'n/a'
            }}
          </p>
        </div>
        <span class="queue-pill">
          {{ barcodeUnits.length }} in queue
        </span>
      </div>

      <label class="form-field">
        <span>Scan / enter barcode</span>
        <input
          [(ngModel)]="barcodeInput"
          (keyup.enter)="submitBarcode()"
          placeholder="Focus here and scan..."
          [disabled]="barcodeAssigning"
          autofocus
        />
      </label>

      <div class="barcode-actions">
        <button class="btn btn-primary" type="button" (click)="submitBarcode()" [disabled]="barcodeAssigning">
          Assign barcode
        </button>
        <button
          class="btn btn-ghost"
          type="button"
          (click)="autoGenerateBarcode()"
          [disabled]="barcodeAssigning"
        >
          Auto barcode
        </button>
        <button class="btn btn-ghost danger" type="button" (click)="skipBarcodeUnit()" [disabled]="barcodeAssigning">
          Skip unit
        </button>
      </div>
      <p class="hint">
        Barcodes are assigned in FIFO order. Skipping sends the unit to the end of the queue.
      </p>
    </div>
    <ng-template #noPending>
      <p class="subtle">
        All units already have barcodes for this item.
      </p>
    </ng-template>
  </ng-container>

  <p class="success" *ngIf="barcodeMessage">{{ barcodeMessage }}</p>
  <p class="error" *ngIf="barcodeError">{{ barcodeError }}</p>
</div>
