<div class="receipt-page">
  <div class="receipt-print" #printArea>
    <div class="ticket" *ngIf="tx; else stateTpl">
      <header class="header">
        <div class="brand">
          <div class="logo">ðŸ§¾</div>
          <div class="brand-text">
            <h2>Store App</h2>
            <small>Some Address â€¢ +961 70 000 000</small>
          </div>
        </div>
        <hr />
        <div class="meta">
          <div>
            <strong>Receipt #</strong> <span>{{ tx.id }}</span>
          </div>
          <div>
            <strong>Date</strong> <span>{{ tx.date | date : "short" }}</span>
          </div>
          <div *ngIf="tx.user">
            <strong>Cashier</strong>
            <span>{{ tx.user?.username || tx.user?.name || tx.user?.id }}</span>
          </div>
          <div *ngIf="tx.customer">
            <strong>Customer</strong>
            <span>{{ tx.customer?.name || tx.customer?.id }}</span>
          </div>
        </div>
        <hr />
      </header>

      <table class="lines">
        <thead>
          <tr>
            <th class="left">Item</th>
            <th class="center">Qty / m</th>
            <th class="right">Price</th>
            <th class="right">Total</th>
          </tr>
        </thead>
                <tbody>
          <ng-container *ngFor="let it of tx.transactionItems">
            <tr>
              <td class="left">
                {{ it.item?.name || "#" + it.item?.id }}
                <small *ngIf="it.mode === 'METER' && it.roll?.id">
                  ??? Roll #{{ it.roll.id }}</small
                >
              </td>
              <td class="center">
                <ng-container *ngIf="it.mode === 'METER'; else eachQty">
                  {{ it.length_m }} m
                </ng-container>
                <ng-template #eachQty>{{ it.quantity }}</ng-template>
              </td>
              <td class="right">{{ it.price_each | number : "1.2-2" }}</td>
              <td class="right">{{ lineTotal(it) | number : "1.2-2" }}</td>
            </tr>
            <tr class="unit-row" *ngIf="it.inventoryUnitLinks?.length">
              <td colspan="4">
                <div class="unit-list">
                  <div
                    class="unit-pill"
                    *ngFor="let link of it.inventoryUnitLinks"
                    role="button"
                    tabindex="0"
                    (click)="toggleUnit(link)"
                    (keydown.enter)="toggleUnit(link)"
                    (keydown.space)="toggleUnit(link)"
                  >
                    <div class="unit-pill-main">
                      <strong>{{ unitLabel(link) }}</strong>
                      <span class="hint" *ngIf="unitHidden(link)">Tap to reveal</span>
                    </div>
                    <div class="unit-pill-badge" *ngIf="unitReturnBadge(link)">
                      {{ unitReturnBadge(link) }}
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>

      <hr />

      <div class="totals">
        <div>
          <span>Subtotal</span>
          <span>{{ total() | number : "1.2-2" }}</span>
        </div>
        <div class="grand">
          <span>Total</span>
          <span>{{ tx.total ?? total() | number : "1.2-2" }}</span>
        </div>
        <div>
          <span>Paid</span>
          <span>{{ (tx.paid ?? 0) | number : "1.2-2" }}</span>
        </div>
        <div>
          <span>Balance</span>
          <span>
            {{
              ((tx.total ?? total()) - (tx.paid ?? 0)) | number : "1.2-2"
            }}
          </span>
        </div>
        <div class="status">
          <span>Status</span>
          <span [class.manual]="tx.statusManualEnabled">
            {{
              (tx.statusCode || tx.status || 'UNPAID')
                | uppercase
            }}
          </span>
        </div>
        <div class="small" *ngIf="tx.statusManualEnabled">
          Manual override: {{ tx.statusManualValue || 'N/A' }}
          <ng-container *ngIf="tx.statusManualNote">
            ({{ tx.statusManualNote }})
          </ng-container>
        </div>
        <div class="small" *ngIf="tx.receipt_type">
          Type: {{ tx.receipt_type }}
        </div>
        <div class="small" *ngIf="tx.lastEditAt || tx.lastEditNote">
          Last edit:
          <ng-container *ngIf="tx.lastEditUser">
            {{ tx.lastEditUser?.name || tx.lastEditUser?.username || ('User #' + tx.lastEditUser?.id) }}
          </ng-container>
          <ng-container *ngIf="tx.lastEditAt">on {{ tx.lastEditAt | date : 'short' }}</ng-container>
          <ng-container *ngIf="tx.lastEditNote">â€” "{{ tx.lastEditNote }}"</ng-container>
        </div>
      </div>

      <footer class="foot">
        <p>Thank you for your purchase!</p>
        <p><small>All sales subject to store policy.</small></p>
      </footer>
    </div>
  </div>

  <ng-template #stateTpl>
    <div class="state no-print" *ngIf="loading">Loadingâ€¦</div>
    <div class="state error no-print" *ngIf="!loading && error">
      {{ error }}
    </div>
  </ng-template>

  <div class="actions no-print" *ngIf="tx">
    <button (click)="print()">Print</button>
    <button (click)="editReceipt()">Edit</button>
    <button (click)="back()">Back</button>
  </div>
</div>


