<div class="view sell-view">
  <header class="view-header">
    <div>
      <h1 class="view-title">Sell</h1>
      <p class="view-subtitle">
        Build a cart, apply wholesale pricing, and record payments on the spot.
      </p>
    </div>
    <div class="header-actions">
      <button class="btn" type="button" (click)="loadItems()">Refresh items</button>
    </div>
  </header>

  <section class="edit-banner" *ngIf="editingTxId">
    <div class="edit-info">
      <strong>Editing receipt #{{ editingTxId }}</strong>
      <span *ngIf="editLoading">Loading receipt…</span>
      <span class="error" *ngIf="editError">{{ editError }}</span>
    </div>
    <button class="btn" type="button" (click)="cancelEditMode()">
      Cancel edit
    </button>
  </section>

  <section class="surface-card controls-card">
    <div class="controls">
      <label class="form-field search-field">
        <span>Search</span>
        <input
          [(ngModel)]="search"
          (input)="applyFilters()"
          placeholder="Search items by name or SKU..."
        />
      </label>

      <label class="form-field">
        <span>Category</span>
        <select [(ngModel)]="selectedCategory" (change)="applyFilters()">
          <option value="">All categories</option>
          <option *ngFor="let c of categories" [value]="c">{{ c | titlecase }}</option>
        </select>
      </label>

      <label class="filter-checkbox">
        <input
          type="checkbox"
          [(ngModel)]="inStockOnly"
          (change)="applyFilters()"
        />
        In stock only
      </label>

      <div class="tier-toggle">
        <span class="tier-label">Default price tier</span>
        <label>
          <input
            type="radio"
            name="tier"
            [(ngModel)]="defaultTier"
            value="retail"
          />
          Retail
        </label>
        <label>
          <input
            type="radio"
            name="tier"
            [(ngModel)]="defaultTier"
            value="wholesale"
          />
          Wholesale
        </label>
      </div>
    </div>
  </section>

  <div class="sell-layout">
    <section class="surface-card catalogue-card">
      <div class="section-header">
        <h2>Items</h2>
        <span class="pill">{{ filteredItems.length }} available</span>
      </div>

      <div class="items-grid">
        <button
          type="button"
          class="item-card"
          *ngFor="let it of filteredItems"
          [class.disabled]="remainingStock(it) === 0"
          (click)="addToCart(it)"
          [title]="remainingStock(it) === 0 ? 'Out of stock' : 'Click to add'"
        >
          <div class="item-card__head">
            <div class="name">{{ it.name }}</div>
            <div class="sku" *ngIf="it.sku">SKU: {{ it.sku }}</div>
          </div>
          <div class="meta">
            <span class="category">{{ it.category | titlecase }}</span>
            <span class="price">
              {{
                (defaultTier === 'wholesale'
                  ? it.priceWholesale ?? it.priceRetail ?? it.price
                  : it.priceRetail ?? it.price ?? it.priceWholesale
                ) | number : '1.2-2'
              }}
              <ng-container *ngIf="it.stockUnit === 'm'">/ m</ng-container>
            </span>
          </div>
          <div class="stock" [class.out]="remainingStock(it) === 0">
            Stock: {{ remainingStock(it) }}
            <ng-container *ngIf="it.stockUnit === 'm'">m</ng-container>
          </div>
        </button>
      </div>
    </section>

    <section class="glass-card cart-card">
      <div class="section-header">
        <h2>Cart</h2>
        <span class="pill" *ngIf="cart.length">{{ cart.length }} line{{ cart.length === 1 ? '' : 's' }}</span>
      </div>

      <form class="scanner-row" (submit)="handleScanSubmit($event)">
        <label class="form-field flex-1">
          <span>Scan barcode</span>
          <input
            name="scanInput"
            [(ngModel)]="scanInput"
            placeholder="Focus here and scan..."
            autocomplete="off"
          />
        </label>
        <button class="btn" type="submit" [disabled]="scanLoading || !scanInput">
          {{ scanLoading ? 'Adding…' : 'Add' }}
        </button>
      </form>
      <p class="error" *ngIf="scanError">{{ scanError }}</p>

      <div class="cart-rows" *ngIf="cart.length; else emptyCart">
        <article class="cart-line" *ngFor="let line of cart; let i = index">
          <header class="cart-line__head">
            <div>
              <div class="cart-name">{{ line.name }}</div>
              <div class="cart-sku" *ngIf="line.sku">SKU: {{ line.sku }}</div>
            </div>
            <button class="icon-btn danger" (click)="removeLine(i)" aria-label="Remove line">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path
                  d="M6 7h12v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V7zm3-4h6l1 1h4v2H4V4h4l1-1z"
                />
              </svg>
            </button>
          </header>

          <div class="cart-line__grid">
            <label class="field-group">
              <span>Price mode</span>
              <select
                [(ngModel)]="line.priceMode"
                (ngModelChange)="onLinePriceModeChange(line)"
              >
                <option value="retail">Retail</option>
                <option value="wholesale">Wholesale</option>
                <option value="custom">Custom</option>
              </select>
            </label>

            <ng-container *ngIf="line.stockUnit !== 'm'; else meterControls">
              <label class="field-group">
                <span>Quantity</span>
                <input
                  type="number"
                  min="1"
                  step="1"
                  [ngModel]="line.quantity"
                  [disabled]="!!line.inventoryUnitIds?.length"
                  (ngModelChange)="updateQuantity(i, $event)"
                />
                <small class="hint">
                  <ng-container *ngIf="line.inventoryUnitIds?.length; else qtyHint">
                    Linked to {{ line.inventoryUnitIds?.length || 0 }} scanned units
                  </ng-container>
                  <ng-template #qtyHint>
                    Available: {{ getItemStock(line.itemId) }}
                  </ng-template>
                </small>
              </label>
            </ng-container>

            <ng-template #meterControls>
              <label class="field-group">
                <span>Metres</span>
                <div class="meter-input">
                  <input
                    type="number"
                    step="0.001"
                    min="0.001"
                    [ngModel]="line.lengthMeters"
                    (ngModelChange)="updateMeters(i, $event)"
                  />
                  <span>m</span>
                </div>
                <small class="hint">
                  Available: {{ getItemStock(line.itemId) }} m
                </small>
              </label>
              <label class="field-group">
                <span>Roll</span>
                <select [(ngModel)]="line.rollId">
                  <option [ngValue]="undefined">Auto-select roll</option>
                  <option *ngFor="let r of line.rolls" [ngValue]="r.id">
                    Roll #{{ r.id }} · {{ r.remaining_m }} m
                  </option>
                </select>
              </label>
            </ng-template>

            <label class="field-group">
              <span>Unit price</span>
              <input
                type="number"
                step="0.01"
                min="0"
                [disabled]="line.priceMode !== 'custom'"
                [ngModel]="line.price"
                (ngModelChange)="onCustomPriceChange(line, $event)"
              />
            </label>
          </div>

          <div class="unit-return-row" *ngIf="line.inventoryUnitIds?.length">
            <div class="unit-return-row__header">
              <span>Units</span>
              <span class="hint" *ngIf="editingTxId">
                <ng-container *ngIf="returnCountForLine(line); else markHint">
                  {{ returnCountForLine(line) }} marked for return
                </ng-container>
                <ng-template #markHint>Tap to mark returns</ng-template>
              </span>
            </div>
            <div class="unit-chips">
              <button
                type="button"
                class="unit-chip"
                *ngFor="let unitId of line.inventoryUnitIds; let chipIdx = index"
                [class.selected]="editingTxId && isUnitMarkedForReturn(unitId)"
                [class.locked]="!canToggleReturn(line, chipIdx)"
                [disabled]="!editingTxId || !canToggleReturn(line, chipIdx)"
                (click)="toggleReturnUnit(line, unitId, chipIdx)"
                [attr.title]="line.scannedBarcodes?.[chipIdx] || ('Unit #' + unitId)"
              >
                <span class="unit-chip__label">{{ unitChipLabel(line, chipIdx, unitId) }}</span>
                <span
                  class="unit-chip__status"
                  *ngIf="editingTxId && isUnitMarkedForReturn(unitId)"
                >
                  Return
                </span>
                <span class="unit-chip__badge" *ngIf="unitStatusBadge(line, chipIdx)">
                  {{ unitStatusBadge(line, chipIdx) }}
                </span>
              </button>
            </div>
            <div class="unit-return-row__actions" *ngIf="editingTxId && returnCountForLine(line)">
              <button type="button" class="link-btn" (click)="clearReturnsForLine(line)">
                Clear selection
              </button>
            </div>
          </div>

          <footer class="cart-line__footer">
            <span class="cart-available">
              Available:
              {{ getItemStock(line.itemId) }}
              <ng-container *ngIf="line.stockUnit === 'm'">m</ng-container>
            </span>
            <span class="cart-total">
              Line total:
              <strong>{{ lineTotal(line) | number : '1.2-2' }}</strong>
            </span>
          </footer>
        </article>
      </div>

      <ng-template #emptyCart>
        <p class="empty-state">No items yet. Click an item on the left to add it.</p>
      </ng-template>

      <label class="form-field">
        <span>Customer name</span>
        <input
          type="text"
          [(ngModel)]="customerName"
          (ngModelChange)="onCustomerNameChange($event)"
          list="customer-options"
          placeholder="Walk-in"
          maxlength="191"
        />
        <datalist id="customer-options">
          <option *ngFor="let customer of customers" [value]="customer.name">
          </option>
        </datalist>
      </label>
      <label class="form-field" *ngIf="customerName.trim()">
        <span>Customer phone</span>
        <input
          type="tel"
          [(ngModel)]="customerPhone"
          placeholder="+961 70 000 000"
          maxlength="40"
        />
      </label>

      <div class="cart-summary">
        <div class="summary-line">
          Subtotal <span>{{ subtotal() | number : '1.2-2' }}</span>
        </div>
      </div>

      <div class="pay-now">
        <label class="form-field">
          <span>Paid now</span>
          <input
            type="number"
            min="0"
            step="0.01"
            [(ngModel)]="paidNow"
            placeholder="0.00"
          />
        </label>
        <label class="form-field">
          <span>Cashbox</span>
          <select [(ngModel)]="cashbox" [disabled]="!paidNow">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
          </select>
        </label>
        <label class="form-field">
          <span>Method</span>
          <select [(ngModel)]="payMethod" [disabled]="!paidNow">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="transfer">Transfer</option>
            <option value="other">Other</option>
          </select>
        </label>
        <label class="form-field flex-1">
          <span>Payment note</span>
          <input
            type="text"
            [(ngModel)]="paymentNote"
            placeholder="Optional"
            [disabled]="!paidNow"
          />
        </label>
      </div>

      <div class="status-row">
        <label class="form-field">
          <span>Status override</span>
          <select [(ngModel)]="statusOverride">
            <option value="">Auto</option>
            <option value="PAID">Marked as Paid</option>
            <option value="PARTIAL">Marked as Partial</option>
            <option value="UNPAID">Marked as Unpaid</option>
          </select>
        </label>
      <label class="form-field flex-1" *ngIf="statusOverride">
        <span>Override note</span>
        <input
          type="text"
          [(ngModel)]="statusOverrideNote"
          placeholder="Why override?"
        />
      </label>
    </div>

      <div class="edit-note" *ngIf="editingTxId">
        <label>
          <span>Why are you editing this receipt?</span>
          <textarea
            rows="2"
            [(ngModel)]="editNote"
            placeholder="Briefly describe the changes so we can audit later."
          ></textarea>
        </label>
      </div>
      <div class="return-summary" *ngIf="editingTxId && returnSelection.size">
        {{ returnSelection.size }}
        unit{{ returnSelection.size === 1 ? '' : 's' }} marked for return. They will appear in
        Returns once you update this receipt.
      </div>

      <div class="checkout-row">
        <input [(ngModel)]="note" placeholder="Receipt note (optional)" />
        <button
          class="btn btn-primary"
          [disabled]="!cart.length || saving || editLoading"
          (click)="checkout()"
        >
          {{
            editingTxId
              ? saving
                ? 'Updating…'
                : 'Update receipt'
              : saving
              ? 'Saving…'
              : 'Checkout'
          }}
        </button>
      </div>
    </section>
  </div>
</div>
