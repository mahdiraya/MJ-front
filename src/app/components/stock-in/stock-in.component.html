<div class="stockin">
  <h2>Stock In (Goods Receipt)</h2>

  <section class="hdr">
    <label>
      Supplier
      <input
        type="text"
        [(ngModel)]="supplierInput"
        (input)="onSupplierInput()"
        (blur)="onSupplierBlur()"
        [attr.list]="'supplier-options'"
        placeholder="Type supplier name"
        autocomplete="off"
        [class.invalid]="supplierTouched && supplierError"
        required
      />
      <datalist id="supplier-options">
        <option *ngFor="let supplier of suppliers" [value]="supplier.name"></option>
      </datalist>
      <small class="hint error" *ngIf="supplierTouched && supplierError">
        {{ supplierError }}
      </small>
      <small class="hint" *ngIf="!supplierError && selectedSupplier">
        ID #{{ selectedSupplier.id }}
        <span *ngIf="selectedSupplier.name">| {{ selectedSupplier.name }}</span>
        <span *ngIf="selectedSupplier.phone">| {{ selectedSupplier.phone }}</span>
        <span *ngIf="selectedSupplier.email">| {{ selectedSupplier.email }}</span>
      </small>
    </label>

    <label>
      Date
      <input type="date" [(ngModel)]="date" />
    </label>

    <label>
      Tax
      <input
        type="number"
        [(ngModel)]="tax"
        step="0.01"
        min="0"
        placeholder="0.00"
      />
    </label>

    <label style="flex: 1">
      Note
      <input type="text" [(ngModel)]="note" placeholder="optional note" />
    </label>
  </section>

  <section class="picker">
    <div class="filters">
      <input
        placeholder="Search items..."
        [(ngModel)]="q"
        (input)="applyFilters()"
      />

      <select [(ngModel)]="category" (change)="applyFilters()">
        <option value="">All categories</option>
        <option *ngFor="let c of categories" [ngValue]="c">{{ c }}</option>
      </select>

      <label class="filter-checkbox">
        <input
          type="checkbox"
          [(ngModel)]="inStockOnly"
          (change)="applyFilters()"
        />
        in stock only
      </label>

      <span class="spacer"></span>

      <button class="btn btn-primary" type="button" (click)="openNewItem()">
        + New item
      </button>
    </div>

    <div class="grid">
      <div class="card" *ngFor="let it of filtered">
        <div class="nm">{{ it.name }}</div>
        <div class="meta">
          <span *ngIf="it.sku">#{{ it.sku }}</span>
          <span>Stock: {{ it.stock }}{{ it.stockUnit || '' }}</span>
        </div>
        <div class="act">
          <button
            class="btn btn-outline"
            *ngIf="it.stockUnit !== 'm'"
            (click)="addEach(it)"
          >
            + EACH
          </button>
          <button
            class="btn btn-outline"
            *ngIf="it.stockUnit === 'm'"
            (click)="addMeter(it)"
          >
            + METER
          </button>
        </div>
      </div>
    </div>
  </section>

  <section class="lines" *ngIf="lines.length">
    <h3>Receipt Lines</h3>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Mode</th>
          <th>Qty / Rolls</th>
          <th>Unit Cost</th>
          <th style="text-align: right">Line Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let l of lines; let i = index">
          <td>{{ l.item?.name }}</td>
          <td>{{ l.mode }}</td>

          <td>
            <ng-container *ngIf="isEach(l); else meterTpl">
              <input
                type="number"
                min="1"
                step="1"
                [ngModel]="getQty(l)"
                (ngModelChange)="onQtyChange(l, $event)"
              />
            </ng-container>

            <ng-template #meterTpl>
              <input
                type="text"
                placeholder="e.g. 100, 120.5, 80"
                [ngModel]="getNewRollInput(l)"
                (ngModelChange)="onNewRollInput(l, $event)"
                style="min-width: 240px"
              />
              <div class="chips" *ngIf="getNewRolls(l).length > 0">
                <span class="chip" *ngFor="let r of getNewRolls(l)">
                  {{ r }}m
                </span>
              </div>
            </ng-template>
          </td>

          <td>
              <input
                type="number"
                min="0"
                step="0.01"
                [ngModel]="l.unitCost ?? ''"
                (ngModelChange)="l.unitCost = $event"
              />
          </td>

          <td style="text-align: right">
            {{ lineTotal(l) | number : '1.2-2' }}
          </td>
          <td>
            <button class="btn btn-danger" (click)="removeLine(i)">Remove</button>
          </td>
        </tr>
      </tbody>
    </table>
  </section>

  <section class="totals" *ngIf="lines.length">
    <div class="summary">
      <div class="grand">Subtotal: {{ subtotal() | number : '1.2-2' }}</div>
      <div>Tax: {{ (tax || 0) | number : '1.2-2' }}</div>
      <div>Total: {{ total() | number : '1.2-2' }}</div>
    </div>

    <div class="payment-fields">
      <label>
        Paid now
        <input
          type="number"
          step="0.01"
          min="0"
          [(ngModel)]="paidNow"
          placeholder="0.00"
        />
      </label>
      <label>
        Cashbox
        <select [(ngModel)]="cashbox">
          <option value="A">Cashbox A</option>
          <option value="B">Cashbox B</option>
          <option value="C">Cashbox C</option>
        </select>
      </label>
      <label>
        Pay method
        <select [(ngModel)]="payMethod">
          <option value="cash">Cash</option>
          <option value="card">Card</option>
          <option value="transfer">Transfer</option>
          <option value="other">Other</option>
        </select>
      </label>
      <label class="wide">
        Payment note
        <input
          type="text"
          [(ngModel)]="paymentNote"
          placeholder="optional"
          [disabled]="!paidNow"
        />
      </label>
    </div>

    <div class="status-fields">
      <label>
        Status override
        <select [(ngModel)]="statusOverride">
          <option value="">Auto</option>
          <option value="PAID">Marked as Paid</option>
          <option value="PARTIAL">Marked as Partial</option>
          <option value="UNPAID">Marked as Unpaid</option>
        </select>
      </label>
      <label class="wide" *ngIf="statusOverride">
        Override note
        <input
          type="text"
          [(ngModel)]="statusOverrideNote"
          placeholder="why override?"
        />
      </label>
    </div>

    <button class="btn btn-primary" (click)="submit()" [disabled]="submitting">
      Save
    </button>
  </section>
</div>

<!-- ===== Quick "New Item" modal ===== -->
<div class="modal-backdrop" *ngIf="newItemOpen" (click)="closeNewItem()"></div>

<div class="modal" *ngIf="newItemOpen" (click)="$event.stopPropagation()">
  <h3>New Item</h3>
  <div class="form-grid">
    <label>
      Name
      <input [(ngModel)]="newItemForm.name" placeholder="Required" />
    </label>

    <label>
      SKU
      <input [(ngModel)]="newItemForm.sku" placeholder="Optional" />
    </label>

    <label>
      Category
      <select [(ngModel)]="newItemForm.category">
        <option value="">(none)</option>
        <option *ngFor="let c of categories" [ngValue]="c">{{ c }}</option>
      </select>
    </label>

    <label>
      Stock unit
      <select [(ngModel)]="newItemForm.stockUnit">
        <option value="EACH">Each (pieces)</option>
        <option value="METER">Meters (rolls)</option>
      </select>
    </label>

    <label *ngIf="newItemForm.stockUnit === 'METER'">
      Roll length (m)
      <input
        type="number"
        step="0.001"
        min="0.001"
        [(ngModel)]="newItemForm.rollLength"
        placeholder="e.g. 100"
      />
    </label>

    <label>
      Retail price
      <input
        type="number"
        step="0.01"
        min="0"
        [(ngModel)]="newItemForm.priceRetail"
        placeholder="Optional"
      />
    </label>

    <label>
      Wholesale price
      <input
        type="number"
        step="0.01"
        min="0"
        [(ngModel)]="newItemForm.priceWholesale"
        placeholder="Optional"
      />
    </label>

    <label style="grid-column: 1 / -1">
      Description
      <input [(ngModel)]="newItemForm.description" placeholder="Optional" />
    </label>
  </div>

  <div class="modal-actions">
    <button class="btn" (click)="closeNewItem()" [disabled]="newItemSubmitting">
      Cancel
    </button>
    <button
      class="btn btn-primary"
      (click)="createNewItem()"
      [disabled]="newItemSubmitting"
    >
      {{ newItemSubmitting ? 'Saving...' : 'Save item' }}
    </button>
  </div>
</div>
